---
api_version: catalog/v1
type: Integration
metadata:
  namespace: sumologic
  name: sumologic-analytics
  annotations:
    io.sensu.catalog.featured: "true"
spec:
  class: supported
  provider: metrics
  display_name: Sumo Logic Analytics
  short_description: Process Sensu data with Sumo Logic for real-time analytics and turn-key dashboards
  supported_platforms:
    - darwin
    - linux
    - windows
  tags:
    - sumologic
    - analytics
    - sensu plus
  contributors:
    - "@sensu"
    - "@calebhailey"
    - "@jspaleta"
    - "@thoward"
  prompts:
    - type: section
      title: Sumo Logic HTTP Logs & Metrics Source
    - type: markdown
      body: |
        This integration requires a Sumo Logic HTTP Logs & Metrics Source URL for integration with Sumo Logic.

        Please visit the Sumo Logic ["HTTP Logs and Metrics Source"] reference documentation for more information.

        ["HTTP Logs and Metrics Source"]: https://help.sumologic.com/03Send-Data/Sources/02Sources-for-Hosted-Collectors/HTTP-Source
    - type: question
      name: sumologic_url
      required: true
      input:
        type: object
        oneOf:
          - type: object
            required:
              - option
            properties:
              option:
                type: string
                title: Sumo Logic Source URL
                const: none
                constLocale:
                  title: "â€”"

          - type: object
            required:
              - option
              - secret
            properties:
              option:
                type: string
                title: Sumo Logic Source URL
                const: secret
                constLocale:
                  title: Secret
                  description: >-
                    Select this option to use Sensu Secrets Management
              secret:
                type: string
                title: Sumo Logic Source URL (Sensu Secret)
                description: >-
                  Select the Sumo Logic Source URL (Sensu Secret)
                ref: secrets/v1/secret/metadata/name
          - type: object
            required:
              - option
              - env_var
            properties:
              option:
                type: string
                title: Sumo Logic Source URL
                const: env_var
                constLocale:
                  title: Environment Variable
                  description: >-
                    Select this option to store sensitive configuration as plain text directly in the Sensu resource definitions.
              env_var:
                type: string
                title: Sumo Logic Source URL
                description: >-
                  Provide the Sumo Logic Source URL (NOTE: this will be stored in the Sensu API as unencrypted plaintext).
    - type: question
      name: sumologic_source_category
      required: true
      input:
        type: string
        title: Source Category
        description: >-
          SumoLogic source category for Sensu events 
        default: "sensu-events"

  resource_patches:
    - resource:
        api_version: pipeline/v1
        type: SumoLogicMetricsHandler
        name: sumologic-metrics
      patches:
        - op: replace
          path: /spec/url
          value: "[[sumologic_url.env_var]]"
        - op: add
          path: /spec/secrets/-
          value:
            secret: "[[sumologic_url.secret]]"
            name: SUMOLOGIC_URL
    - resource:
        api_version: core/v2
        type: Handler
        name: sumologic-events
      patches:
        - op: add
          path: /spec/env_vars/-
          value: "SUMOLOGIC_SOURCE_CATEGORY=[[sumologic_source_category]]"
        - op: add
          path: /spec/env_vars/-
          value: "SUMOLOGIC_URL=[[sumologic_url.env_var]]"
        - op: add
          path: /spec/secrets/-
          value:
            secret: "[[sumologic_url.secret]]"
            name: SUMOLOGIC_URL
  post_install:
    - type: section
      title: Success
    - type: markdown
      body: |
        You have successfully enabled the Sumo Logic integration.

        Checks configured with the `sumologic` pipeline will send metrics and event data to Sumo Logic.

        ```yaml
        spec:
          pipelines:
            - api_version: core/v2
              type: Pipeline
              name: sumologic
        ```
