## Overview

<!-- Sensu Integration description; supports markdown -->

Kubernetes API liveness health check. This integration is designed to work with the default [Kubernetes service account] credentials that are available if run from a Sensu Agent sidecar or Daemonset (i.e. from a Kubernetes Pod).

<!-- Provide a high level overview of the integration contents (e.g. checks, filters, mutators, handlers, assets, etc) -->

This integration provides the following resources:

* A `kubernetes-liveness` [check].
* A `kubelet-metrics` [check].
* A `kubelet-probe-metrics` [check].
* A `kubelet-cadvisor-metrics` [check].
* The `sensu/http-checks` [asset].

## Dashboards

<!-- List of supported dashboards w/ screenshots (supports png, jpeg, and gif images; relative paths only; e.g. `![](img/dashboard-1.png)` )-->

There are no supported dashboards for this integration.

## Setup

<!-- Sensu Integration setup instructions, including Sensu agent configuration and external component configuration -->
<!-- EXAMPLE: what configuration (if any) is required in a third-party service to enable monitoring? -->

1. One or more Sensu Agent(s) with access to the Kubernetes API (i.e. `kube-apiserver`).

   By default, a `sensu-agent` running in a Kubernetes pod will have access to the Kubernetes API Server via the `kubernetes.default.svc` DNS record.

   [kube-apiserver]: https://kubernetes.io/docs/reference/command-line-tools-reference/kube-apiserver/

1. One Sensu Agent per Kubelet host.

   A `sensu-agent` running directly on the Kubelet host _or_ in a [Kubernetes Daemonset] with `hostNetwork: true` and `dnsPolicy: ClusterFirstWithHostNet` will have access to the Kubelet API(s) via `localhost` or `127.0.0.1`.

   Click to expand the "details" below for an example Kubernetes Daemonset manifest:

   <details>

   ```yaml
   ---
   kind: DaemonSet
   apiVersion: apps/v1
   metadata:
     name: sensu-agent
   spec:
     minReadySeconds: 10
     updateStrategy:
       type: RollingUpdate
       rollingUpdate:
         maxUnavailable: 1
     selector:
       matchLabels:
         app: sensu-agent
     template:
       metadata:
         labels:
           app: sensu-agent
       spec:
         tolerations: []
         terminationGracePeriodSeconds: 30
         hostPID: true
         hostIPC: true
         hostNetwork: true
         dnsPolicy: ClusterFirstWithHostNet
         volumes: []
         containers:
         - name: sensu-agent
           image: sensu/sensu:6.6.3
           command: [
             "/opt/sensu/bin/sensu-agent", "start",
             "--detect-cloud-provider", "true",
             "--log-level", "warn",
           ]
           env:
           - name: KUBELET_HOST
             valueFrom:
               fieldRef:
                 fieldPath: status.hostIP
           - name: KUBE_NAMESPACE
             valueFrom:
               fieldRef:
                 fieldPath: metadata.namespace
           - name: SENSU_BACKEND_URL
             value: "wss://sensu.yourcompany.com:8081"
           - name: SENSU_NAMESPACE
             value: "sensu-system"
           - name: SENSU_SUBSCRIPTIONS
             value: "kubernetes kubernetes/api kubernetes/daemonset"
           - name: SENSU_KEEPALIVE_INTERVAL
             value: "30"
           - name: SENSU_KEEPALIVE_WARNING_TIMEOUT
             value: "120"
           - name: SENSU_DEREGISTER
             value: "true"
           ports: []
           resources:
             limits:
               cpu: 1.0
               memory: 1024M
             requests:
               cpu: 0.25
               memory: 256M
   ```

   </details>

   [Kubernetes Daemonset]: https://kubernetes.io/docs/concepts/workloads/controllers/daemonset/

## Plugins

<!-- Links to any Sensu Integration dependencies (i.e. Sensu Plugins) -->

* [[sensu/http-checks:0.5.0]](https://bonsai.sensu.io/assets/sensu/http-checks) ([GitHub](https://github.com/sensu/http-checks))

## Metrics & Events

<!-- List of all metrics or events collected by this integration. -->

This integration collects [Metrics from Kubernetes System Components, including `kube-apiserver` and `kubelet` metrics][kubernetes-metrics].

[kubernetes-metrics]: https://kubernetes.io/docs/concepts/cluster-administration/system-metrics/

## Alerts

<!-- List of all alerts generated by this integration. -->

* Generates a warning event whenever the [Kubernetes `/livez` API][kubernetes-health-apis] is reporting an error (i.e. returning an HTTP 400+ response code).

## Reference Documentation

<!-- Please provide links to any relevant reference documentation to help users learn more and/or troubleshoot this integration. -->

1. **Kubernetes Health Checks**

   See: https://kubernetes.io/docs/reference/using-api/health-checks/

   The `curl` command equivalent of this integration (if run from a Kubernetes pod):

   ```shell
   curl -s && \
   --header "Authorization: Bearer $(cat /var/run/secrets/kubernetes.io/serviceaccount/token)" && \
   --cacert /var/run/secrets/kubernetes.io/serviceaccount/ca.crt && \
   https://kubernetes.default.svc:${KUBERNETES_SERVICE_PORT:-443}/livez?verbose
   ```

   The `wget` command equivalent of this integration (if run from a Kubernetes pod):

   ```shell
   wget -q -O- && \
   --header "Authorization: Bearer $(cat /var/run/secrets/kubernetes.io/serviceaccount/token)" && \
   --ca-certificate /var/run/secrets/kubernetes.io/serviceaccount/ca.crt && \
   https://kubernetes.default.svc:${KUBERNETES_SERVICE_PORT:-443}/livez?verbose
   ```

2. **Kubernetes Service Accounts**

   See: https://kubernetes.io/docs/tasks/configure-pod-container/configure-service-account/

3. **Accessing the Kubernetes API from a Pod**

   See: https://kubernetes.io/docs/tasks/run-application/access-api-from-pod/#directly-accessing-the-rest-api

   Related:

   - Kubernetes serice discovery reference documentation: https://kubernetes.io/docs/concepts/services-networking/service/#environment-variables
   - The built-in pod environment variable `KUBERNETES_SERVICE_HOST` is also mapped to the `kubernetes.default.svc` hostname
   - The built-in pod environment variable `KUBERNETES_SERVICE_PORT` is also available in case it's not set to the default (`443`)


<!-- Links -->
[check]: https://docs.sensu.io/sensu-go/latest/observability-pipeline/observe-schedule/checks/
[asset]: https://docs.sensu.io/sensu-go/latest/plugins/assets/
[subscription]: https://docs.sensu.io/sensu-go/latest/observability-pipeline/observe-schedule/subscriptions/
[agents]: https://docs.sensu.io/sensu-go/latest/observability-pipeline/observe-schedule/agent/
[annotation]: https://docs.sensu.io/sensu-go/latest/observability-pipeline/observe-schedule/agent/#general-configuration-flags
[plugins]: https://docs.sensu.io/sensu-go/latest/plugins/
[metrics]: https://docs.sensu.io/sensu-go/latest/observability-pipeline/observe-schedule/metrics/
[handler]: https://docs.sensu.io/sensu-go/latest/observability-pipeline/observe-process/handlers/

[kubernetes-health-apis]: https://kubernetes.io/docs/reference/using-api/health-checks/
[Kubernetes service account]: https://kubernetes.io/docs/tasks/configure-pod-container/configure-service-account/