---
api_version: catalog/v1
type: Integration
metadata:
  namespace: "servicenow"
  name: "servicenow-cmdb-registration"
spec:
  class: enterprise
  provider: discovery
  display_name: ServiceNow CMDB Registration
  short_description: Automatically register Sensu entities as ServiceNow CMDB Configuration Items
  supported_platforms:
    - darwin
    - linux
    - windows
  tags:
    - servicenow
    - discovery
    - cmdb
    - assets
  contributors:
    - "@sensu"
    - "@calebhailey"
  prompts:
    - type: section
      title: ServiceNow Instance Configuration
    - type: markdown
      body: |
        Specify the ServiceNow instance URL, username, and password.
    - type: question
      name: servicenow_url
      required: true
      input:
        type: string
        format: url
        title: ServiceNow instance base URL
        description:
          Enter the ServiceNow intance base URL
        default: https://mycompany.service-now.com
    - type: question
      name: servicenow_username
      required: true
      input:
        type: object
        oneOf:
          - type: object
            required:
              - option
              - secret
            properties:
              option:
                type: string
                title: ServiceNow username
                const: secret
                constLocale:
                  title: Secret
                  description: >-
                    Use a Sensu secret to provide the ServiceNow username
              secret:
                type: string
                title: Secret name
                description: >-
                  Enter the secret name for the ServiceNow username
                ref: secrets/v1/secret/metadata/name
          - type: object
            required:
              - option
              - env_var
            properties:
              option:
                type: string
                title: ServiceNow username
                const: env_var
                constLocale:
                  title: Environment variable
                  description: >-
                    Save the ServiceNow username as a backend environment variable
              env_var:
                type: string
                title: ServiceNow username
                description: >-
                  Enter the ServiceNow username (username will be stored in the Sensu API as unencrypted plaintext)
    - type: question
      name: servicenow_password
      required: true
      input:
        type: object
        oneOf:
          - type: object
            required:
              - option
              - secret
            properties:
              option:
                type: string
                title: ServiceNow password
                const: secret
                constLocale:
                  title: Secret
                  description: >-
                    Use a Sensu secret to provide the ServiceNow password
              secret:
                type: string
                title: Secret name
                description: >-
                  Enter the secret name for the ServiceNow password
                ref: secrets/v1/secret/metadata/name
          - type: object
            required:
              - option
              - env_var
            properties:
              option:
                type: string
                title: ServiceNow password
                const: env_var
                constLocale:
                  title: Environment variable
                  description: >-
                    Save the ServiceNow password as a backend environment variable
              env_var:
                type: string
                title: ServiceNow password
                description: >-
                  Enter the ServiceNow password (password will be stored in the Sensu API as unencrypted plaintext)
    - type: section
      title: ServiceNow Customizations
    - type: markdown
      body: |
        If your organization has a customized ServiceNow instance, provide the following configuration information to customize this integration:

        * Name of the ServiceNow CMDB table to use for managing Configuration Items (CIs)
        * CMDB key: the field name that Sensu should use to look up CIs
        * [Handler templates] for CI and asset tag naming
        * Custom CI properties to populate from Sensu entity annotations

        If you do not have a customized ServiceNow instance, the default values will work with unmodified ServiceNow instances.

        [handler template]: https://docs.sensu.io/sensu-go/latest/observability-pipeline/observe-process/handler-templates/
    - type: question
      name: servicenow_cmdb_table
      required: true
      input:
        type: string
        title: CMDB table
        description: >-
          Enter the name of the ServiceNow table to use for managing CIs.
        default: cmdb_ci
    - type: question
      name: servicenow_cmdb_key
      required: true
      input:
        type: string
        title: CMDB key
        description: >-
          Enter the CMDB key (the field name Sensu should use to look up CIs)
        default: name
    - type: question
      name: servicenow_cmdb_name
      required: true
      input:
        type: string
        title: CMDB naming template
        description: >-
          Enter the handler template to use to generate CI names
        default: "{{ .Entity.Name }}"
    - type: question
      name: servicenow_cmdb_asset_tag
      required: true
      input:
        type: string
        title: CMDB asset tag template
        description: >-
          Enter the handler template to use to generate CI asset tags
        default: "sensu/{{ .Entity.Namespace }}/{{ .Entity.Name }}"
    - type: question
      name: servicenow_cmdb_properties
      required: true
      input:
        type: string
        title: Custom CI properties
        description: >-
          Enter a comma-separated list of custom CI properties to populate from Sensu entity annotations
        default: asset_tag
  resource_patches:
    - resource:
        api_version: core/v2
        type: Handler
        name: servicenow-cmdb
      patches:
        - op: replace
          path: /spec/command
          value: >-
            sensu-servicenow-handler
            --cmdb-registration
            --cmdb-table [[servicenow_cmdb_table]]
            --cmdb-key [[servicenow_cmdb_key]]
            --cmdb-name "[[servicenow_cmdb_name]]"
            --cmdb-asset-tag "[[servicenow_cmdb_asset_tag]]"
            --cmdb-properties "[[servicenow_cmdb_properties]]"
        - op: add
          path: /spec/env_vars/-
          value: "SERVICENOW_URL=[[servicenow_url]]"
        - op: add
          path: /spec/env_vars/-
          value: "SERVICENOW_USERNAME=[[servicenow_username.env_var]]"
        - op: add
          path: /spec/env_vars/-
          value: "SERVICENOW_PASSWORD=[[servicenow_password.env_var]]"
        - op: add
          path: /spec/secrets/-
          value:
            secret: "[[servicenow_username.secret]]"
            name: SERVICENOW_USERNAME
        - op: add
          path: /spec/secrets/-
          value:
            secret: "[[servicenow_password.secret]]"
            name: SERVICENOW_PASSWORD
  post_install:
    - type: section
      title: Success
    - type: markdown
      body: |
        You enabled the ServiceNow CMDB Registration integration.

        To enable ServiceNow CMDB registration for all entities, list the `servicenow-cmdb` handler as a keepalive handler in the `agent.yml` configuration file and restart the agent:

        ```yaml
        keepalive-handlers:
          - servicenow-cmdb
        ```

        To enable ServiceNow CMDB registration only for entities that execute a specific check, add the `servicenow-cmdb` pipeline to the check definition:

        ```yaml
        spec:
          pipelines:
            - api_version: core/v2
              type: Pipeline
              name: servicenow-cmdb
        ```